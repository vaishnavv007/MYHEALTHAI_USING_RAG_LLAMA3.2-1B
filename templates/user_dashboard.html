{% extends "base.html" %}
{% block content %}
<div class="container">
<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded shadow-sm">
  <h2 class="mb-0 ">Welcome, {{ username }}!</h2>
  <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
    <i class="bi bi-box-arrow-right  text-info"></i> Logout
  </a>
</div>


  <hr>



  </div>

  <hr>

  <!-- ===== Chat with Bot ===== -->
 <!-- ===== Chat Assistant with Typewriter Effect ===== -->
<!-- ===== Enhanced Chat Assistant UI ===== -->
<!-- ===== Enhanced Chat Assistant ===== -->
<h4>Chat with AI</h4>
<div id="chat-container">
  <!-- Messages will appear here -->
</div>

<form id="chat-form" style="display: flex; gap: 10px; margin-top: 10px;">
  <textarea id="user-input" name="prompt" rows="2" placeholder="Type your question..." required></textarea>
  <button type="submit" id="send-btn">Send</button>
</form>

<style>
#chat-container {
  height: 400px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 15px;
  background-color: #fefefe;
  font-family: Arial, sans-serif;
  border-radius: 8px;
  scroll-behavior: smooth;
}

.user-msg, .bot-msg {
  margin: 10px 0;
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 15px;
  clear: both;
  display: inline-block;
  line-height: 1.4;
}

.user-msg {
  background-color: #d1e7dd;
  float: right;
  text-align: right;
}

.bot-msg {
  background-color: #e2e3e5;
  float: left;
  text-align: left;
  font-family: monospace;
}

#chat-form textarea {
  flex: 1;
  resize: none;
  border-radius: 6px;
  border: 1px solid #aaa;
  padding: 10px;
  font-size: 14px;
}

#send-btn {
  background-color: #007bff;
  border: none;
  color: white;
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
}

#send-btn:hover {
  background-color: #0056b3;
}
</style>

<script>
const chatContainer = document.getElementById('chat-container');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');

function appendMessage(type, text, animate = false) {
  const msgDiv = document.createElement('div');
  msgDiv.className = type === 'user' ? 'user-msg' : 'bot-msg';
  chatContainer.appendChild(msgDiv);

  if (animate && type === 'bot') {
    const words = text.split(' ');
    let index = 0;
    const interval = setInterval(() => {
      if (index < words.length) {
        msgDiv.innerHTML += words[index] + ' ';
        index++;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } else {
        clearInterval(interval);
      }
    }, 150);
  } else {
    msgDiv.textContent = text;
  }

  chatContainer.scrollTop = chatContainer.scrollHeight;
}

chatForm.addEventListener('submit', async function (e) {
  e.preventDefault();
  const question = userInput.value.trim();
  if (!question) return;

  appendMessage('user', question);
  userInput.value = '';

  try {
    const res = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `prompt=${encodeURIComponent(question)}`
    });
    const data = await res.json();
    appendMessage('bot', data.answer, true);
  } catch (err) {
    appendMessage('bot', 'Error: Failed to fetch response.');
  }
});

// Support Enter to send (Shift+Enter for newline)
userInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    chatForm.dispatchEvent(new Event('submit'));
  }
});
</script>






<!-- üìÅ File-based Qwen Chat Assistant -->
<div class="mt-4 p-4 border rounded shadow bg-white" style="max-width: 600px;">
  <h4 class="mb-3 fw-bold">üìÑ Ask from Document</h4>

  <!-- File Upload -->
  <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2 mb-3">
    <input type="file" id="fileInput" class="form-control" accept=".pdf">
    <button onclick="uploadFile()" class="btn btn-primary">Upload</button>
  </div>

  <p id="uploadStatus" class="form-text text-muted mb-3"></p>

  <!-- Chat Section (Visible by default for testing, remove style="display:block;" in production) -->
  <div id="fileChatSection" style="display: block;">
    <div id="fileChatBox" class="border rounded bg-light p-2 mb-3" style="height: 250px; overflow-y: auto;"></div>

    <div class="input-group">
      <input type="text" id="fileUserInput" class="form-control" placeholder="Ask your question..." onkeypress="if(event.key==='Enter') askFromFile()">
      <button class="btn btn-success" onclick="askFromFile()">Ask</button>
    </div>
  </div>
</div>


<script>
let uploadedFilename = "";

function uploadFile() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  fetch("/upload_file", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.filename) {
      uploadedFilename = data.filename;
      document.getElementById("fileChatSection").classList.remove("hidden");
      document.getElementById("uploadStatus").innerText = `‚úÖ Uploaded: ${file.name}`;
      document.getElementById("fileChatBox").innerHTML = "";
    } else {
      document.getElementById("uploadStatus").innerText = "‚ùå Upload failed.";
    }
  })
  .catch(() => {
    document.getElementById("uploadStatus").innerText = "‚ùå Upload error.";
  });
}

function askFromFile() {
  const question = document.getElementById("fileUserInput").value.trim();
  if (!question || !uploadedFilename) return;

  const box = document.getElementById("fileChatBox");
  const userDiv = document.createElement("div");
  userDiv.classList.add("mb-2");
  userDiv.innerHTML = `<strong>You:</strong> ${question}`;
  box.appendChild(userDiv);
  box.scrollTop = box.scrollHeight;

  document.getElementById("fileUserInput").value = "";

  fetch("/qwen_chat", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: uploadedFilename, question: question })
  })
  .then(res => res.json())
  .then(data => {
    if (data.answer) {
      typeWriter(data.answer, box);
    } else {
      const errorDiv = document.createElement("div");
      errorDiv.innerHTML = `<strong>Bot:</strong> ‚ùå Failed to get response.`;
      box.appendChild(errorDiv);
      box.scrollTop = box.scrollHeight;
    }
  })
  .catch(() => {
    const errorDiv = document.createElement("div");
    errorDiv.innerHTML = `<strong>Bot:</strong> ‚ùå Server error.`;
    box.appendChild(errorDiv);
    box.scrollTop = box.scrollHeight;
  });
}

function typeWriter(text, box, i = 0, spanId = `botReply-${Date.now()}`) {
  if (i === 0) {
    const botDiv = document.createElement("div");
    botDiv.innerHTML = `<strong>Bot:</strong> <span id="${spanId}"></span>`;
    box.appendChild(botDiv);
    box.scrollTop = box.scrollHeight;
  }
  if (i < text.length) {
    const span = document.getElementById(spanId);
    if (span) {
      span.innerHTML += text.charAt(i);
      box.scrollTop = box.scrollHeight;
      setTimeout(() => typeWriter(text, box, i + 1, spanId), 20);
    }
  }
}
</script>









<!-- ===== Interactive Chat Assistant History ===== -->

<h4 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 12px;">Chat History</h4>

<div id="chat-history" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 12px; background-color: #fafafa;">
  {% for session in chat_sessions %}
  <div class="session-block" style="border: 1px solid #ccc; border-radius: 6px; padding: 12px; margin-bottom: 15px; background-color: #fff;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
      <button class="section-toggle" data-section="{{ session.section }}"
              style="font-weight: bold; background: none; border: none; color: #007bff; cursor: pointer;">
        Section {{ session.section }}
      </button>
      <a href="{{ url_for('delete_section', section=session.section) }}"
         style="color: red; text-decoration: none; font-size: 0.9rem;" 
         onclick="return confirm('Are you sure you want to delete this section?');">
        Delete Section
      </a>
    </div>

    <ul class="questions-list" id="section-{{ session.section }}" style="display: none; list-style: none; padding-left: 0;">
      {% for qa in session.messages %}
      <li style="margin: 8px 0; border-left: 3px solid #007bff; padding-left: 8px;">
        <button class="question-btn" data-answer="{{ qa.answer|e }}"
                style="background: none; border: none; color: #333; text-align: left; width: 100%; cursor: pointer; font-size: 0.95rem;">
          ‚ùì {{ qa.question }}
        </button>
        <div class="answer-box" style="display: none; padding: 6px 0 0 12px; color: #28a745; font-size: 0.9rem;"></div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endfor %}
</div>


<script>
document.querySelectorAll('.section-toggle').forEach(button => {
  button.addEventListener('click', () => {
    const sectionId = 'section-' + button.getAttribute('data-section');
    const list = document.getElementById(sectionId);
    list.style.display = (list.style.display === 'none') ? 'block' : 'none';
  });
});

document.querySelectorAll('.question-btn').forEach(button => {
  button.addEventListener('click', () => {
    const answerBox = button.nextElementSibling;
    if (answerBox.style.display === 'none') {
      answerBox.style.display = 'block';
      answerBox.textContent = button.getAttribute('data-answer');
    } else {
      answerBox.style.display = 'none';
    }
  });
});
</script>




<div class="card p-4 mb-4">
  <h4 class="mb-3">Check Your BMI</h4>

  <form method="POST" action="{{ url_for('calculate_bmi') }}">
    <div class="mb-3">
      <label for="height" class="form-label">Height (cm):</label>
      <input type="number" step="0.1" name="height" id="height" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="weight" class="form-label">Weight (kg):</label>
      <input type="number" step="0.1" name="weight" id="weight" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary">Calculate</button>
  </form>

  {% if latest_bmi %}
    <div class="alert alert-info mt-3">
      <strong>Latest BMI:</strong> {{ latest_bmi.bmi }} ({{ latest_bmi.date }})
    </div>
  {% endif %}

  <div class="mt-4">
    <h5>BMI History</h5>
    <button class="btn btn-outline-secondary btn-sm mb-2" onclick="toggleBmiHistory()">Show History</button>

    <ul id="bmi-history" class="list-group" style="display: none;">
      {% for bmi in bmi_history %}
      <li class="list-group-item">
        {{ bmi.date }} - BMI: {{ bmi.bmi }}
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
function toggleBmiHistory() {
  const list = document.getElementById("bmi-history");
  const button = event.target;
  if (list.style.display === "none") {
    list.style.display = "block";
    button.textContent = "Hide History";
  } else {
    list.style.display = "none";
    button.textContent = "Show History";
  }
}
</script>


  <!-- ===== Doctor Directory ===== -->
  <!-- ===== Doctor Directory ===== -->
<h4>Doctor Directory</h4>

<!-- Filter Form -->
<form method="get" action="{{ url_for('user_dashboard') }}" class="mb-4">
  <div class="row g-2 align-items-end">

    <div class="col-md-3">
      <label for="state" class="form-label">State</label>
      <select name="state" id="state" class="form-select">
        <option value="">All States</option>
        {% for s in states %}
          <option value="{{ s }}" {% if selected_state == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="district" class="form-label">District</label>
      <select name="district" id="district" class="form-select">
        <option value="">All Districts</option>
        {% for d in districts %}
          <option value="{{ d }}" {% if selected_district == d %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="category" class="form-label">Category</label>
      <select name="category" id="category" class="form-select">
        <option value="">All Categories</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>

  </div>
</form>

<!-- Doctors List -->
<div class="container my-4">
  <h4 class="mb-3">Doctor Directory</h4>

  <div class="doctor-list border rounded p-3 overflow-auto" style="max-height: 500px;">
    {% for doctor in doctors %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body doctor-summary" onclick="toggleDetails('{{ doctor._id }}')" style="cursor: pointer;">
          <h5 class="card-title mb-1">{{ doctor.name }} <small class="text-muted">({{ doctor.category }})</small></h5>
          <p class="mb-1">‚≠ê <strong>{{ doctor.rating }}</strong></p>
          <p class="mb-0 text-muted">üìç {{ doctor.location }}</p>
        </div>

        <div id="details-{{ doctor._id }}" class="card-body border-top doctor-details" style="display: none;">
          <p><strong>Qualification:</strong> {{ doctor.qualification }}</p>
          <p><strong>Gender:</strong> {{ doctor.gender }}</p>
          <p><strong>Hospital:</strong> {{ doctor.hospital }}</p>
          <p><strong>State:</strong> {{ doctor.state }}</p>
          <p><strong>District:</strong> {{ doctor.district }}</p>
          <p><strong>Location:</strong> {{ doctor.location }}</p>
          <p><strong>Phone:</strong> {{ doctor.phone }}</p>
          <a href="{{ doctor.map_link }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">View on Map</a>
        </div>
      </div>
    {% endfor %}
  </div>
</div>



<script>
  function toggleDetails(id) {
    const details = document.getElementById("details-" + id);
    details.style.display = (details.style.display === "none") ? "block" : "none";
  }
</script>







<!-- ===== Add Medical Report Form ===== -->
<h4 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 12px;">Add Medical Report</h4>

<form method="POST" action="{{ url_for('add_medical') }}"
      style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; overflow-x: auto;">
  
  <input name="disease_or_injury" placeholder="Disease or Injury" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 160px;">
  
  <input type="date" name="date_visited" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 140px;">
  
  <input name="hospital_name" placeholder="Hospital Name" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 160px;">
  
  <input name="medicine_name" placeholder="Medicine Name" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 160px;">
  
  <input name="days" placeholder="No. of Days" type="number" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px;">
  
  <input name="dosage_schedule" placeholder="Dosage Schedule (e.g. Morning)" required
         style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 180px;">
  
  <button type="submit"
          style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
    Add Report
  </button>
</form>


<hr>

<!-- ===== Medical Report Table ===== -->
<h4 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">Your Medical Reports</h4>

<div style="border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">

  <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
    <thead style="background: #f0f0f0; position: sticky; top: 0; z-index: 2;">
      <tr>
        <th style="padding: 10px; text-align: left;">Disease/Injury</th>
        <th style="padding: 10px; text-align: left;">Date</th>
        <th style="padding: 10px; text-align: left;">Hospital</th>
        <th style="padding: 10px; text-align: left;">Medicine</th>
        <th style="padding: 10px; text-align: left;">Days</th>
        <th style="padding: 10px; text-align: left;">Dosage</th>
        <th style="padding: 10px; text-align: left;">Actions</th>
      </tr>
    </thead>
  </table>

  <!-- Scrollable tbody wrapper -->
  <div style="max-height: calc(4 * 48px); overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
      <tbody>
        {% for report in medical_reports %}
        <tr style="border-top: 1px solid #eee;">
          <td style="padding: 8px;">{{ report.disease_or_injury }}</td>
          <td style="padding: 8px;">{{ report.date_visited }}</td>
          <td style="padding: 8px;">{{ report.hospital_name }}</td>
          <td style="padding: 8px;">{{ report.medicine_name }}</td>
          <td style="padding: 8px;">{{ report.days }}</td>
          <td style="padding: 8px;">{{ report.dosage_schedule }}</td>
          <td style="padding: 8px;">
            <a href="{{ url_for('edit_medical', id=report._id) }}" style="color: blue; text-decoration: underline;">Edit</a> |
            <a href="{{ url_for('delete_medical', id=report._id) }}" style="color: red;" onclick="return confirm('Delete this report?');">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>








  <hr>
  <a href="{{ url_for('logout') }}">Logout</a>
</div>
{% endblock %}
